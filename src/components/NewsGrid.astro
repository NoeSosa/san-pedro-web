---
import { fetchApi, getStrapiMedia } from "../lib/strapi";
import type { StrapiResponse, NoticiaAttributes } from "../interfaces/strapi";

interface Props {
    limit?: number;
}

const { limit = 6 } = Astro.props;

let noticias: any[] = [];
let error = null;

try {
    const response = await fetchApi<StrapiResponse<NoticiaAttributes[]>>({
        endpoint: "noticias",
        query: {
            sort: ["fecha:desc"],
            pagination: {
                limit: limit,
            },
            populate: {
                imagen_destacada: "*",
                etiquetas: "*",
            },
        },
    });
    noticias = response.data;
} catch (e) {
    console.error("Error cargando noticias:", e);
    error = e;
}
---

{
    error && (
        <div class="p-4 bg-red-50 text-red-600 rounded-lg text-center">
            No se pudieron cargar las noticias en este momento.
        </div>
    )
}

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
    {
        noticias.map((noticia) => {
            const { titulo, slug, fecha, imagen_destacada, etiquetas } =
                noticia.attributes;
            const imageUrl = getStrapiMedia(
                imagen_destacada.data?.attributes?.formats?.small?.url ||
                    imagen_destacada.data?.attributes?.url,
            );

            const fechaFormateada = new Date(fecha).toLocaleDateString(
                "es-MX",
                {
                    day: "numeric",
                    month: "short",
                    year: "numeric",
                },
            );

            return (
                <a
                    href={`/noticias/${slug}`}
                    class="group block bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1"
                >
                    <div class="relative h-48 overflow-hidden">
                        {imageUrl ? (
                            <img
                                src={imageUrl}
                                alt={titulo}
                                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
                                loading="lazy"
                            />
                        ) : (
                            <div class="w-full h-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-gray-400">
                                <svg
                                    class="w-12 h-12"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                                    />
                                </svg>
                            </div>
                        )}

                        {/* Etiquetas flotantes */}
                        <div class="absolute top-3 left-3 flex flex-wrap gap-2">
                            {etiquetas.data.slice(0, 2).map((tag) => (
                                <span
                                    class={`text-xs font-bold px-2 py-1 rounded-md shadow-sm backdrop-blur-md ${tag.attributes.color || "bg-white/90 text-gray-800"}`}
                                >
                                    {tag.attributes.nombre}
                                </span>
                            ))}
                        </div>
                    </div>

                    <div class="p-5">
                        <time class="text-xs text-gray-500 dark:text-gray-400 font-medium uppercase tracking-wider mb-2 block">
                            {fechaFormateada}
                        </time>
                        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2 line-clamp-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                            {titulo}
                        </h3>
                        <p class="text-gray-600 dark:text-gray-300 text-sm line-clamp-3">
                            {/* Aquí podrías poner un extracto si lo tienes, o dejarlo vacío */}
                            Clic para leer la nota completa...
                        </p>
                    </div>
                </a>
            );
        })
    }
</div>
