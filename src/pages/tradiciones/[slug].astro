---
import Layout from "../../layouts/Layout.astro";
import StrapiBlockRenderer from "../../components/StrapiBlockRenderer";
import { fetchApi, getStrapiMedia } from "../../lib/strapi";
import type {
    StrapiResponse,
    TradicionAttributes,
    StrapiData,
} from "../../interfaces/strapi";

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

let tradicion: StrapiData<TradicionAttributes> | undefined;

try {
    const response = await fetchApi<
        StrapiResponse<StrapiData<TradicionAttributes>[]>
    >({
        endpoint: "tradiciones",
        query: {
            filters: {
                slug: {
                    $eq: slug,
                },
            },
            populate: {
                imagen_principal: "*",
            },
        },
    });

    if (response.data && response.data.length > 0) {
        tradicion = response.data[0];
    }
} catch (error) {
    console.error("Error cargando tradicion:", error);
}

if (!tradicion) {
    return Astro.redirect("/404");
}

const { titulo, contenido, imagen_principal } = tradicion;
const imageUrl = getStrapiMedia(imagen_principal?.[0]?.url);
---

<Layout title={titulo}>
    <div class="relative h-[50vh]">
        {
            imageUrl ? (
                <img
                    src={imageUrl}
                    alt={titulo}
                    class="w-full h-full object-cover"
                    transition:name={`tradicion-image-${slug}`}
                />
            ) : (
                <div class="w-full h-full bg-gray-800 flex items-center justify-center">
                    <span class="text-white text-2xl">Sin imagen</span>
                </div>
            )
        }
        <div
            class="absolute inset-0 bg-black/50 flex items-center justify-center"
        >
            <h1
                class="text-4xl md:text-6xl font-bold text-white drop-shadow-lg px-4 text-center"
            >
                {titulo}
            </h1>
        </div>
    </div>

    <article class="container mx-auto px-6 py-12 max-w-3xl">
        <div
            class="bg-white p-8 md:p-12 rounded-2xl shadow-sm border border-gray-100"
        >
            <StrapiBlockRenderer content={contenido} />
        </div>

        <div class="mt-12 border-t pt-8">
            <a
                href="/#tradicion"
                class="text-blue-900 font-bold hover:text-blue-600 flex items-center gap-2 transition-colors"
            >
                &larr; Volver a Tradiciones
            </a>
        </div>
    </article>
</Layout>
