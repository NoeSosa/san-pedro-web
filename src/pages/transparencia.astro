---
import Layout from "../layouts/Layout.astro";
import { fetchApi, getStrapiMedia } from "../lib/strapi";
import type {
    StrapiResponse,
    DocumentoAttributes,
    StrapiData,
} from "../interfaces/strapi";

// 1. Obtener todos los documentos desde Strapi
let documentos: StrapiData<DocumentoAttributes>[] = [];

try {
    const response = await fetchApi<
        StrapiResponse<StrapiData<DocumentoAttributes>[]>
    >({
        endpoint: "documentos",
        query: {
            sort: ["fecha:desc"], // Ordenar por fecha descendente
            populate: {
                archivo: {
                    fields: ["url", "name", "ext", "size"],
                },
            },
        },
    });
    documentos = response.data;
} catch (error) {
    console.error("Error cargando documentos:", error);
}

// 2. Categorías con labels amigables
const categorias: Record<string, string> = {
    actas: "Actas de Cabildo",
    finanzas: "Finanzas Públicas",
    obras: "Obras e Infraestructura",
    normatividad: "Marco Legal y Reglamentos",
    otros: "Otros Documentos",
};

// 3. Agrupar documentos por categoría (normalizar a minúsculas)
const docsPorCategoria = documentos.reduce(
    (acc: Record<string, StrapiData<DocumentoAttributes>[]>, doc) => {
        const cat = doc.categoria.toLowerCase(); // Normalizar a minúsculas
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(doc);
        return acc;
    },
    {},
);

// 4. Función para formatear fecha
const formatDate = (dateString: string) => {
    return new Intl.DateTimeFormat("es-MX", { dateStyle: "long" }).format(
        new Date(dateString),
    );
};
---

<Layout title="Transparencia | San Pedro Huamelula">
    <div
        class="bg-gradient-to-r from-blue-900 to-blue-700 text-white py-20 text-center relative overflow-hidden"
    >
        <div class="absolute inset-0 bg-[url('/pattern.svg')] opacity-10"></div>
        <div class="relative z-10 container mx-auto px-6">
            <h1 class="text-5xl font-extrabold mb-4 tracking-tight">
                Portal de Transparencia
            </h1>
            <p class="text-blue-200 text-xl max-w-2xl mx-auto font-light">
                Acceso público a la información gubernamental. Rendición de
                cuentas clara y accesible para todos.
            </p>
        </div>
    </div>

    <section class="py-16 bg-gray-50 min-h-screen">
        <div class="container mx-auto px-6 max-w-5xl">
            {
                documentos.length === 0 ? (
                    <div class="text-center py-20 bg-white rounded-2xl shadow-lg p-12 border border-gray-200">
                        <div class="inline-block p-6 rounded-full bg-blue-100 mb-6">
                            <svg
                                class="w-16 h-16 text-blue-600"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                />
                            </svg>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-800 mb-2">
                            No hay documentos disponibles
                        </h3>
                        <p class="text-gray-500 text-lg">
                            Aún no se han publicado documentos en la plataforma.
                        </p>
                    </div>
                ) : (
                    <div class="space-y-12">
                        {Object.entries(categorias).map(([key, label]) => {
                            const documentosDeEstaCategoria =
                                docsPorCategoria[key];

                            if (!documentosDeEstaCategoria) return null;

                            return (
                                <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200 hover:shadow-xl transition-shadow duration-300">
                                    <div class="bg-gradient-to-r from-blue-900 to-blue-700 px-6 py-5 flex items-center gap-3">
                                        <div class="p-2.5 bg-white/20 backdrop-blur-sm rounded-lg">
                                            <svg
                                                xmlns="http://www.w3.org/2000/svg"
                                                class="h-7 w-7 text-white"
                                                fill="none"
                                                viewBox="0 0 24 24"
                                                stroke="currentColor"
                                            >
                                                <path
                                                    stroke-linecap="round"
                                                    stroke-linejoin="round"
                                                    stroke-width="2"
                                                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                                />
                                            </svg>
                                        </div>
                                        <h2 class="text-2xl font-bold text-white">
                                            {label}
                                        </h2>
                                        <span class="ml-auto px-3 py-1 bg-white/20 backdrop-blur-sm rounded-full text-sm font-bold text-white">
                                            {documentosDeEstaCategoria.length}{" "}
                                            {documentosDeEstaCategoria.length ===
                                            1
                                                ? "documento"
                                                : "documentos"}
                                        </span>
                                    </div>

                                    <div class="divide-y divide-gray-100">
                                        {documentosDeEstaCategoria.map(
                                            (doc) => {
                                                const archivoUrl =
                                                    getStrapiMedia(
                                                        doc.archivo?.url,
                                                    );
                                                const archivoNombre =
                                                    doc.archivo?.name ||
                                                    "documento";
                                                const archivoExt =
                                                    doc.archivo?.ext?.toUpperCase() ||
                                                    "PDF";

                                                return (
                                                    <div class="p-6 hover:bg-blue-50 transition-colors duration-200 flex flex-col sm:flex-row sm:items-center justify-between gap-4 group">
                                                        <div class="flex-grow">
                                                            <h3 class="font-bold text-blue-900 dark:text-blue-600 text-lg mb-2 group-hover:text-blue-700 transition-colors">
                                                                {doc.titulo}
                                                            </h3>
                                                            <div class="flex items-center gap-4 text-sm text-gray-600 dark:text-gray-400">
                                                                <span class="flex items-center gap-1.5">
                                                                    <svg
                                                                        xmlns="http://www.w3.org/2000/svg"
                                                                        class="h-4 w-4"
                                                                        fill="none"
                                                                        viewBox="0 0 24 24"
                                                                        stroke="currentColor"
                                                                    >
                                                                        <path
                                                                            stroke-linecap="round"
                                                                            stroke-linejoin="round"
                                                                            stroke-width="2"
                                                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                                                                        />
                                                                    </svg>
                                                                    {formatDate(
                                                                        doc.fecha,
                                                                    )}
                                                                </span>
                                                                <span class="px-2 py-0.5 bg-gray-100 dark:bg-gray-700 rounded text-xs font-bold uppercase">
                                                                    {archivoExt}
                                                                </span>
                                                            </div>
                                                        </div>

                                                        {archivoUrl ? (
                                                            <a
                                                                href={
                                                                    archivoUrl
                                                                }
                                                                download={
                                                                    archivoNombre
                                                                }
                                                                target="_blank"
                                                                rel="noopener noreferrer"
                                                                class="flex items-center justify-center gap-2 bg-blue-900 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition-all shadow-md hover:shadow-lg whitespace-nowrap group-hover:scale-105 duration-200"
                                                            >
                                                                <svg
                                                                    xmlns="http://www.w3.org/2000/svg"
                                                                    class="h-5 w-5"
                                                                    fill="none"
                                                                    viewBox="0 0 24 24"
                                                                    stroke="currentColor"
                                                                >
                                                                    <path
                                                                        stroke-linecap="round"
                                                                        stroke-linejoin="round"
                                                                        stroke-width="2"
                                                                        d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"
                                                                    />
                                                                </svg>
                                                                Descargar
                                                            </a>
                                                        ) : (
                                                            <span class="text-gray-400 italic text-sm">
                                                                Archivo no
                                                                disponible
                                                            </span>
                                                        )}
                                                    </div>
                                                );
                                            },
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                )
            }
        </div>
    </section>
</Layout>
