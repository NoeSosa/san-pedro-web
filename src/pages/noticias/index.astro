---
import Layout from "../../layouts/Layout.astro";
import NoticiaCard from "../../components/ui/NoticiaCard.astro";
import { fetchApi } from "../../lib/strapi";
import type {
    StrapiResponse,
    NoticiaAttributes,
    EtiquetaAttributes,
    StrapiData,
} from "../../interfaces/strapi";

// 1. Obtener datos de Strapi
let noticias: StrapiData<NoticiaAttributes>[] = [];
let etiquetas: StrapiData<EtiquetaAttributes>[] = [];

try {
    // Fetch Noticias (Limitamos a 100 para esta vista general)
    const noticiasRes = await fetchApi<
        StrapiResponse<StrapiData<NoticiaAttributes>[]>
    >({
        endpoint: "noticias",
        query: {
            sort: ["fecha_publicacion:desc"],
            pagination: { limit: 100 },
            populate: {
                imagen_destacada: {
                    fields: [
                        "url",
                        "alternativeText",
                        "width",
                        "height",
                        "formats",
                    ],
                },
                etiquetas: {
                    fields: ["nombre", "color"],
                },
            },
        },
    });
    noticias = noticiasRes.data;

    // Fetch Etiquetas
    const etiquetasRes = await fetchApi<
        StrapiResponse<StrapiData<EtiquetaAttributes>[]>
    >({
        endpoint: "etiquetas",
        query: {
            sort: ["nombre:asc"],
        },
    });
    etiquetas = etiquetasRes.data;
} catch (error) {
    console.error("Error fetching news page data:", error);
}
---

<Layout title="Noticias y Comunicados | San Pedro Huamelula">
    <div
        class="bg-gradient-to-r from-blue-700 via-blue-600 to-blue-700 text-white py-24 text-center relative overflow-hidden"
    >
        <div
            class="absolute inset-0 bg-[radial-gradient(circle_at_50%_50%,rgba(255,255,255,0.1),transparent_50%)] opacity-20"
        >
        </div>
        <div class="relative z-10 container mx-auto px-4">
            <h1 class="text-5xl md:text-6xl font-black mb-6 tracking-tight">
                Noticias y Comunicados
            </h1>
            <p
                class="text-blue-100 text-xl max-w-3xl mx-auto font-light leading-relaxed"
            >
                Mantente informado sobre las acciones, obras y eventos de tu
                gobierno municipal.
            </p>
        </div>
    </div>

    <section class="py-20 bg-gradient-to-b from-gray-50 to-white min-h-screen">
        <div class="container mx-auto px-6">
            <!-- Filtros -->
            <div class="flex flex-wrap justify-center gap-3 mb-14">
                <button
                    class="filter-btn active px-6 py-3 rounded-full text-sm font-extrabold transition-all shadow-md bg-blue-600 text-white ring-2 ring-blue-600 ring-offset-2 hover:bg-blue-700 hover:shadow-lg"
                    data-filter="all"
                >
                    Todas
                </button>
                {
                    etiquetas.map((tag) => (
                        <button
                            class="filter-btn px-6 py-3 rounded-full text-sm font-bold transition-all shadow-sm bg-white text-gray-700 hover:bg-gray-50 hover:shadow-md hover:text-blue-700 border-2 border-gray-200 hover:border-blue-300"
                            data-filter={tag.nombre}
                        >
                            {tag.nombre}
                        </button>
                    ))
                }
            </div>

            <!-- Grid de Noticias -->
            <div
                id="news-grid"
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
            >
                {
                    noticias.map((noticia) => {
                        // Crear string de nombres de etiquetas para filtrado
                        const tagNames = noticia.etiquetas
                            .map((t) => t.nombre)
                            .join(",");

                        return (
                            <div
                                class="news-item transition-all duration-500"
                                data-tags={tagNames}
                            >
                                <NoticiaCard noticia={noticia} />
                            </div>
                        );
                    })
                }
            </div>

            <!-- Mensaje cuando no hay resultados -->
            <div id="no-results" class="hidden text-center py-20">
                <div class="inline-block p-4 rounded-full bg-gray-100 mb-4">
                    <svg
                        class="w-8 h-8 text-gray-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        ><path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
                        ></path></svg
                    >
                </div>
                <p class="text-gray-500 text-lg font-medium">
                    No se encontraron noticias con esta categoría.
                </p>
                <button
                    id="reset-filters"
                    class="mt-4 text-blue-600 font-bold hover:underline"
                >
                    Ver todas las noticias
                </button>
            </div>
        </div>
    </section>
</Layout>

<script>
    document.addEventListener("astro:page-load", () => {
        const filterButtons = document.querySelectorAll(".filter-btn");
        const newsItems = document.querySelectorAll(".news-item");
        const noResultsMsg = document.getElementById("no-results");
        const resetBtn = document.getElementById("reset-filters");

        const filterNews = (filterValue: string) => {
            let visibleCount = 0;

            // Actualizar botones
            filterButtons.forEach((b) => {
                if (b.getAttribute("data-filter") === filterValue) {
                    b.classList.remove(
                        "bg-white",
                        "text-gray-600",
                        "border-gray-200",
                    );
                    b.classList.add(
                        "bg-blue-900",
                        "text-white",
                        "ring-2",
                        "ring-blue-900",
                        "ring-offset-2",
                    );
                } else {
                    b.classList.add(
                        "bg-white",
                        "text-gray-600",
                        "border-gray-200",
                    );
                    b.classList.remove(
                        "bg-blue-900",
                        "text-white",
                        "ring-2",
                        "ring-blue-900",
                        "ring-offset-2",
                    );
                }
            });

            // Filtrar items
            newsItems.forEach((item) => {
                const itemTags = (item.getAttribute("data-tags") || "").split(
                    ",",
                );

                if (filterValue === "all" || itemTags.includes(filterValue)) {
                    (item as HTMLElement).style.display = "block";
                    // Pequeña animación de entrada
                    (item as HTMLElement).style.opacity = "0";
                    setTimeout(() => {
                        (item as HTMLElement).style.opacity = "1";
                    }, 50);
                    visibleCount++;
                } else {
                    (item as HTMLElement).style.display = "none";
                }
            });

            // Toggle mensaje
            if (visibleCount === 0 && noResultsMsg) {
                noResultsMsg.classList.remove("hidden");
            } else if (noResultsMsg) {
                noResultsMsg.classList.add("hidden");
            }
        };

        filterButtons.forEach((btn) => {
            btn.addEventListener("click", () => {
                const filterValue = btn.getAttribute("data-filter");
                if (filterValue) filterNews(filterValue);
            });
        });

        resetBtn?.addEventListener("click", () => {
            filterNews("all");
        });
    });
</script>
