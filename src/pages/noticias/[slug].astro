---
import Layout from "../../layouts/Layout.astro";
import StrapiBlockRenderer from "../../components/StrapiBlockRenderer";
import { fetchApi, getStrapiMedia } from "../../lib/strapi";
import type {
    StrapiResponse,
    NoticiaAttributes,
} from "../../interfaces/strapi";

// Habilitar SSR para esta página (ya que buscamos por slug dinámico)
export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

let noticia;

try {
    const response = await fetchApi<StrapiResponse<NoticiaAttributes[]>>({
        endpoint: "noticias",
        query: {
            filters: {
                slug: {
                    $eq: slug,
                },
            },
            populate: {
                imagen_destacada: "*",
                etiquetas: "*",
            },
        },
    });

    if (response.data && response.data.length > 0) {
        noticia = response.data[0];
    }
} catch (error) {
    console.error("Error cargando noticia:", error);
}

if (!noticia) {
    return Astro.redirect("/404");
}

const { titulo, fecha, contenido, imagen_destacada, etiquetas } =
    noticia.attributes;
const imageUrl = getStrapiMedia(imagen_destacada.data?.attributes?.url);

// Formatear fecha
const fechaFormateada = new Date(fecha).toLocaleDateString("es-MX", {
    year: "numeric",
    month: "long",
    day: "numeric",
});
---

<Layout title={titulo} description={titulo}>
    <article class="max-w-4xl mx-auto px-4 py-12">
        {/* Cabecera de la Noticia */}
        <header class="mb-10 text-center">
            <div class="flex flex-wrap justify-center gap-2 mb-4">
                {
                    etiquetas.data.map((tag) => (
                        <span
                            class={`px-3 py-1 rounded-full text-sm font-medium ${tag.attributes.color || "bg-gray-100 text-gray-800"}`}
                        >
                            {tag.attributes.nombre}
                        </span>
                    ))
                }
            </div>

            <h1
                class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4 leading-tight"
            >
                {titulo}
            </h1>

            <time
                datetime={fecha}
                class="text-gray-500 dark:text-gray-400 text-lg"
            >
                {fechaFormateada}
            </time>
        </header>

        {/* Imagen Destacada */}
        {
            imageUrl && (
                <div class="mb-12 rounded-2xl overflow-hidden shadow-xl aspect-video">
                    <img
                        src={imageUrl}
                        alt={
                            imagen_destacada.data?.attributes
                                ?.alternativeText || titulo
                        }
                        class="w-full h-full object-cover"
                        transition:name={`image-${slug}`}
                    />
                </div>
            )
        }

        {/* Contenido Rico */}
        <div
            class="bg-white dark:bg-gray-800 p-8 md:p-12 rounded-2xl shadow-sm"
        >
            <StrapiBlockRenderer content={contenido} />
        </div>
    </article>
</Layout>
