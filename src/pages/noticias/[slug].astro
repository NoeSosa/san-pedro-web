---
import Layout from "../../layouts/Layout.astro";
import StrapiBlockRenderer from "../../components/StrapiBlockRenderer";
import ImageCarousel from "../../components/ImageCarousel";
import { fetchApi, getStrapiMedia } from "../../lib/strapi";
import type {
    StrapiResponse,
    NoticiaAttributes,
    StrapiData,
} from "../../interfaces/strapi";

// Habilitar SSR para esta p치gina (ya que buscamos por slug din치mico)
export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect("/404");
}

let noticia: StrapiData<NoticiaAttributes> | undefined;

try {
    const response = await fetchApi<
        StrapiResponse<StrapiData<NoticiaAttributes>[]>
    >({
        endpoint: "noticias",
        query: {
            filters: {
                slug: {
                    $eq: slug,
                },
            },
            populate: {
                imagen_destacada: {
                    fields: [
                        "url",
                        "alternativeText",
                        "width",
                        "height",
                        "formats",
                    ],
                },
                etiquetas: {
                    fields: ["nombre", "color"],
                },
            },
        },
    });

    if (response.data && response.data.length > 0) {
        noticia = response.data[0];
    }
} catch (error) {
    console.error("Error cargando noticia:", error);
}

if (!noticia) {
    return Astro.redirect("/404");
}

const { titulo, fecha_publicacion, contenido, imagen_destacada, etiquetas } =
    noticia;

// Preparar las im치genes para el carrusel (filtrar las que no tengan URL)
// Asegurarse de que imagen_destacada sea un array antes de usar .map()
const imagenesArray = Array.isArray(imagen_destacada) ? imagen_destacada : [];
const imagenes = imagenesArray
    .map((img) => ({
        url: getStrapiMedia(img.url),
        alt: img.alternativeText || titulo,
        width: img.width,
        height: img.height,
    }))
    .filter((img) => img.url !== null) as {
    url: string;
    alt: string;
    width: number;
    height: number;
}[];

// Formatear fecha
const fechaFormateada = new Date(fecha_publicacion).toLocaleDateString(
    "es-MX",
    {
        year: "numeric",
        month: "long",
        day: "numeric",
    },
);
---

<Layout title={titulo}>
    <article class="max-w-5xl mx-auto px-4 py-16 md:py-20">
        {/* Cabecera de la Noticia */}
        <header
            class="mb-12 text-center bg-gradient-to-br from-white to-gray-50 p-10 md:p-12 rounded-3xl shadow-lg border border-gray-100"
        >
            <div class="flex flex-wrap justify-center gap-2 mb-6">
                {
                    etiquetas?.map((tag) => (
                        <span
                            class={`px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wide shadow-sm ${tag.color || "bg-blue-100 text-blue-800"}`}
                        >
                            {tag.nombre}
                        </span>
                    ))
                }
            </div>

            <h1
                class="text-4xl md:text-6xl lg:text-7xl font-extrabold text-gray-900 mb-6 leading-tight tracking-tight text-balance"
            >
                {titulo}
            </h1>

            <time
                datetime={fecha_publicacion}
                class="text-gray-600 text-lg font-medium flex items-center justify-center gap-2"
            >
                <svg
                    class="w-5 h-5"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
                    ></path>
                </svg>
                {fechaFormateada}
            </time>
        </header>

        {/* Carrusel de Im치genes */}
        {
            imagenes.length > 0 && (
                <div class="mb-14 rounded-3xl overflow-hidden shadow-xl border border-gray-100">
                    <ImageCarousel client:load images={imagenes} />
                </div>
            )
        }

        {/* Contenido Rico */}
        <div
            class="bg-white p-8 md:p-12 lg:p-16 rounded-3xl shadow-lg border border-gray-100"
        >
            <StrapiBlockRenderer content={contenido} />
        </div>

        <div class="mt-14 pt-10 border-t-2 border-gray-100">
            <a
                href="/noticias"
                class="inline-flex items-center gap-3 text-blue-700 font-bold hover:text-blue-900 transition-all duration-200 group text-lg"
            >
                <svg
                    class="w-6 h-6 transition-transform group-hover:-translate-x-1"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2.5"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Volver a Noticias
            </a>
        </div>
    </article>
</Layout>
